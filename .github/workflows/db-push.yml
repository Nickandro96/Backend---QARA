name: DB Migrate (safe) & Baseline

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install deps
        run: pnpm install

      - name: Debug DATABASE_URL presence (masked)
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "DATABASE_URL is EMPTY"
            exit 1
          fi
          echo "DATABASE_URL is set (length=${#DATABASE_URL})"
          echo "$DATABASE_URL" | sed -E 's#(mysqls?://[^:]+:)[^@]+@#\1****@#'

      - name: Rename legacy table processes -> processus (idempotent, SSL + retry)
        run: |
          node - <<'NODE'
          const mysql = require("mysql2/promise");

          function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

          function parseDbUrl(dbUrl) {
            const u = new URL(dbUrl);
            const dbName = u.pathname.replace(/^\//, "") || "railway";
            return {
              host: u.hostname,
              port: Number(u.port || 3306),
              user: decodeURIComponent(u.username),
              password: decodeURIComponent(u.password),
              database: dbName,
              ssl: { rejectUnauthorized: false },
              connectTimeout: 15000,
              multipleStatements: true,
            };
          }

          async function connectWithRetry(dbUrl, retries = 6) {
            const cfg = parseDbUrl(dbUrl);
            let lastErr;
            for (let i = 1; i <= retries; i++) {
              try {
                const conn = await mysql.createConnection(cfg);
                await conn.query("SELECT 1");
                return conn;
              } catch (e) {
                lastErr = e;
                console.error(`[DB] connect attempt ${i}/${retries} failed:`, e?.code || e?.message || e);
                await sleep(2000 * i);
              }
            }
            throw lastErr;
          }

          (async () => {
            if (!process.env.DATABASE_URL) throw new Error("DATABASE_URL missing");
            const conn = await connectWithRetry(process.env.DATABASE_URL);

            const [a] = await conn.query(`SHOW TABLES LIKE 'processes'`);
            const [b] = await conn.query(`SHOW TABLES LIKE 'processus'`);

            if (a.length === 0) {
              console.log("No rename needed for processes ✅");
              await conn.end();
              return;
            }
            if (b.length > 0) {
              console.log("Table 'processus' already exists, skipping rename ✅");
              await conn.end();
              return;
            }

            console.log("Renaming table processes -> processus ...");
            await conn.query(`RENAME TABLE \`processes\` TO \`processus\``);
            console.log("Rename done ✅");
            await conn.end();
          })().catch((e) => { console.error(e); process.exit(1); });
          NODE

      # ✅ Apply raw SQL migrations in drizzle/migrations/*.sql
      - name: Apply SQL migrations from drizzle/migrations
        run: pnpm exec tsx scripts/apply-sql-migrations.ts

      # ✅ Ensure Drizzle journal exists then migrate (single-step, safe)
      - name: Ensure Drizzle journal exists then migrate (single-step, safe)
        run: |
          set -euxo pipefail

          echo "CWD=$(pwd)"
          ls -la

          JOURNAL='{"version":"5","dialect":"mysql","entries":[]}'

          for d in \
            "meta" \
            "drizzle/meta" \
            "drizzle/migrations/meta" \
            "migrations/meta"
          do
            mkdir -p "$d"
            if [ ! -f "$d/_journal.json" ]; then
              echo "$JOURNAL" > "$d/_journal.json"
            fi
          done

          mkdir -p drizzle/migrations
          mkdir -p migrations

          echo "== meta =="
          ls -la meta || true
          echo "== drizzle/meta =="
          ls -la drizzle/meta || true
          echo "== drizzle/migrations/meta =="
          ls -la drizzle/migrations/meta || true
          echo "== migrations/meta =="
          ls -la migrations/meta || true

          pnpm exec drizzle-kit migrate --config=drizzle.config.ts
