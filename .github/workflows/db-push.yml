name: DB Migrate (safe) & Baseline

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install deps
        run: pnpm install

      - name: Debug DATABASE_URL presence (masked)
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "DATABASE_URL is EMPTY"
            exit 1
          fi
          echo "DATABASE_URL is set (length=${#DATABASE_URL})"
          echo "$DATABASE_URL" | sed -E 's#(mysqls?://[^:]+:)[^@]+@#\1****@#'

      # ✅ Idempotent rename: processes -> processus (only if needed)
      - name: Rename legacy table processes -> processus (idempotent)
        run: |
          node - <<'NODE'
          const mysql = require("mysql2/promise");

          (async () => {
            const url = process.env.DATABASE_URL;
            const conn = await mysql.createConnection(url);

            const [a] = await conn.query(`SHOW TABLES LIKE 'processes'`);
            const [b] = await conn.query(`SHOW TABLES LIKE 'processus'`);

            if (a.length === 0) {
              console.log("No rename needed for processes ✅");
              await conn.end();
              return;
            }
            if (b.length > 0) {
              console.log("Table 'processus' already exists, skipping rename ✅");
              await conn.end();
              return;
            }

            console.log("Renaming table processes -> processus ...");
            await conn.query(`RENAME TABLE \`processes\` TO \`processus\``);
            console.log("Rename done ✅");

            await conn.end();
          })().catch((e) => {
            console.error(e);
            process.exit(1);
          });
          NODE

      # ✅ Ensure Drizzle meta/journal exists so `drizzle-kit migrate` can run
      - name: Ensure drizzle/meta/_journal.json exists (required by migrate)
        run: |
          node - <<'NODE'
          const fs = require("fs");
          const path = require("path");

          const metaDir = path.join(process.cwd(), "drizzle", "meta");
          const migDir  = path.join(process.cwd(), "drizzle", "migrations");
          const journalPath = path.join(metaDir, "_journal.json");

          if (!fs.existsSync(metaDir)) fs.mkdirSync(metaDir, { recursive: true });
          if (!fs.existsSync(migDir)) fs.mkdirSync(migDir, { recursive: true });

          if (!fs.existsSync(journalPath)) {
            const journal = { version: "5", dialect: "mysql", entries: [] };
            fs.writeFileSync(journalPath, JSON.stringify(journal), "utf8");
            console.log("Created drizzle/meta/_journal.json ✅");
          } else {
            console.log("drizzle/meta/_journal.json already exists ✅");
          }
          NODE

      # ✅ Optional baseline table creation (keeps data, doesn't drop anything)
      - name: Ensure __drizzle_migrations table exists (safe)
        run: |
          node - <<'NODE'
          const mysql = require("mysql2/promise");

          (async () => {
            const url = process.env.DATABASE_URL;
            const conn = await mysql.createConnection(url);

            await conn.query(`
              CREATE TABLE IF NOT EXISTS \`__drizzle_migrations\` (
                \`id\` int NOT NULL AUTO_INCREMENT,
                \`hash\` varchar(255) NOT NULL,
                \`created_at\` bigint NOT NULL,
                PRIMARY KEY (\`id\`),
                UNIQUE KEY \`__drizzle_migrations_hash_unique\` (\`hash\`)
              )
            `);

            console.log("__drizzle_migrations ensured ✅");
            await conn.end();
          })().catch((e) => {
            console.error(e);
            process.exit(1);
          });
          NODE

      # ❌ DO NOT run `drizzle-kit generate` in CI (it recreates 0000_... and conflicts with existing tables)
      - name: Run migrations (no-op if none committed)
        run: pnpm exec drizzle-kit migrate --config=drizzle.config.ts
